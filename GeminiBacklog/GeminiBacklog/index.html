<!DOCTYPE html>
<html>
<head>
    <title>Gemini Backlog</title>
    <meta charset="utf-8" />
    <script src="Scripts/jquery-2.2.3.min.js"></script>
    <script src="Scripts/handlebars.min.js"></script>
    <script src="Scripts/jquery-ui-1.11.4.min.js"></script>
    <link href="Content/site.css" rel="stylesheet" />
    <link href="Content/themes/base/all.css" rel="stylesheet" />
    <script type="text/javascript">

        Dashboard = {
            init: function () {
                function bindToTemplate(opts) {
                    var source = $(opts.templateSelector).html(),
                            template = Handlebars.compile(source);
                    return $(opts.destinationSelector).html(template(opts.data));
                }

                function getPriortisedBacklog() {
                    $.get('/GeminiBacklog/issues', function (issues) {
                        bindToTemplate({ data: issues, templateSelector: '#issues-template', destinationSelector: '#backlog' });
                    });
                }

                function getWorkHistoryForUser() {
                    var tabIndex = $('#tabs').tabs('option', 'active'),
                        userId = $($('#tabs').tabs().find('li')[tabIndex]).attr('data-gemini-user-id');

                    if (userId)
                        $.get('/GeminiBacklog/loggedtimes/' + userId + '/' + $('#availableDates').val(), function (data) {
                            var source = $('#history-template').html(),
                            template = Handlebars.compile(source);
                            $('#history').html(template(data));
                        });
                }

                function bindAvailableDates() {
                    $.get('/GeminiBacklog/permissibledates', function (dates) {
                        bindToTemplate({
                            data: dates,
                            templateSelector: '#availabledates-template', destinationSelector: '#dates'
                        }).on('change', getWorkHistoryForUser);
                    });
                }

                function createTabs(people) {
                    bindToTemplate({
                        templateSelector: '#tabs-template',
                        data: people, destinationSelector: '#tabs'
                    }).tabs({ activate: getWorkHistoryForUser });

                    getPriortisedBacklog();
                    bindAvailableDates();
                }

                $.getJSON('/GeminiBacklog/people', createTabs);
            }
        };

        $(Dashboard.init);
    </script>
</head>
<body>
    <div id="tabs"></div>
    <script id="tabs-template" type="text/x-handlebars-template">
        <ul>
            <li><a href="#backlog">Dev Priorities</a></li>
            {{#people}}
            <li data-gemini-user-id="{{geminiId}}"><a href="#workdone">{{name}}</a></li>
            {{/people}}
        </ul>
        <div id="backlog"></div>
        <div id="workdone">
            <div id="dates">
            </div>
            <div id="history" />
        </div>
    </script>
    <script id="availabledates-template" type="text/x-handlebars">
        <select id="availableDates">
            {{#availableDates}}
            <option value="{{dateValue}}">{{dateText}}</option>
            {{/availableDates}}
        </select>
    </script>
    <script id="issues-template" type="text/x-handlebars-template">
        <div class="row">
            <div class="column grid_1 strong">Issue</div>
            <div class="column grid_6 strong">Summary</div>
            <div class="column grid_1 strong">Status</div>
            <div class="column grid_1 strong">Type</div>
            <div class="column grid_1 strong">DueDate</div>
            <div class="column grid_1 strong">Created</div>
            <div class="column grid_1 strong">Priority</div>
        </div>
        {{#issues}}
        <div class="row bordered">
            <div class="column grid_1">{{issue}}</div>
            <div class="column grid_3">{{summary}}</div>
            <div class="column grid_2">{{status}}</div>
            <div class="column grid_2">{{type}}</div>
            <div class="column grid_1">{{#if dueDate}} {{dueDate}} {{else}}&nbsp;{{/if}}</div>
            <div class="column grid_1">{{created}}</div>
            <div class="column grid_1">{{priority}}</div>
        </div>
        {{/issues}}
    </script>
    <script id="history-template" type="text/x-handlebars-template">
        <div class="row">
            <div class="column grid_1 strong">ID</div>
            <div class="column grid_6 strong">Issue</div>
            <div class="column grid_1 strong">Monday</div>
            <div class="column grid_1 strong">Tuesday</div>
            <div class="column grid_1 strong">Wednesday</div>
            <div class="column grid_1 strong">Thursday</div>
            <div class="column grid_1 strong">Friday</div>
        </div>
        {{#history}}
        <div class="row">
            <div class="column grid_1">{{geminiRef}}</div>
            <div class="column grid_6">{{issue}}</div>
            <div class="column grid_1">{{monday}}</div>
            <div class="column grid_1">{{tuesday}}</div>
            <div class="column grid_1">{{wednesday}}</div>
            <div class="column grid_1">{{thursday}}</div>
            <div class="column grid_1">{{friday}}</div>
        </div>
        {{/history}}
        <div class="row sum">
            <div class="column grid_7 strong alignRight">Total:</div>
            <div class="column grid_1">{{total.monday}}</div>
            <div class="column grid_1">{{total.tuesday}}</div>
            <div class="column grid_1">{{total.wednesday}}</div>
            <div class="column grid_1">{{total.thursday}}</div>
            <div class="column grid_1">{{total.friday}}</div>
        </div>
    </script>
</body>
</html>
