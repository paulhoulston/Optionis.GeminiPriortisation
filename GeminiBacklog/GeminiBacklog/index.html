<!DOCTYPE html>
<html>
<head>
    <title>Gemini Backlog</title>
    <meta charset="utf-8" />
    <script src="Scripts/jquery-2.2.3.min.js"></script>
    <script src="Scripts/handlebars.min.js"></script>
    <script src="Scripts/jquery-ui-1.11.4.min.js"></script>
    <link href="Content/site.css" rel="stylesheet" />
    <link href="Content/themes/base/all.css" rel="stylesheet" />
    <script type="text/javascript">
        $(function () {

            function getWorkHistoryForUser() {
                var tabIndex = $('#tabs').tabs('option', 'active'),
                    userId = $($('#tabs').tabs().find('li')[tabIndex]).attr('data-gemini-user-id');

                if (userId)
                    $.get('/GeminiBacklog/loggedtimes/' + userId + '/' + $('#availableDates').val(), function (data) {
                        var source = $('#history-template').html(),
                        template = Handlebars.compile(source);
                        $('#history').html(template(data));
                    });
            }

            function getPriortisedBacklog() {
                $.get('/GeminiBacklog/issues', function (issues) {
                    var source = $('#issues-template').html(),
                        template = Handlebars.compile(source);
                    $('#backlog').html(template(issues));
                });
            }

            function bindAvailableDates() {
                var datesList = $('#availableDates').on('change', getWorkHistoryForUser);
                $.get('/GeminiBacklog/permissibledates', function (dates) {
                    $(dates).each(function (i, o) {
                        datesList.append($('<option/>', { text: o.dateText, value: o.dateValue }));
                    })
                });
            }

            getPriortisedBacklog();
            bindAvailableDates();
            $('#tabs').tabs({ activate: getWorkHistoryForUser });
        });
    </script>
</head>
<body>
    <div id="tabs">
        <ul>
            <li><a href="#backlog">Priorities</a></li>
            <li data-gemini-user-id="81"><a href="#workdone">Paul Houlston</a></li>
            <li data-gemini-user-id="33"><a href="#workdone">Ross Cooper</a></li>
            <li data-gemini-user-id="54"><a href="#workdone">Simon Aspinall</a></li>
        </ul>
        <div id="backlog"></div>
        <div id="workdone">
            <div>
                <select id="availableDates"></select>
            </div>
            <div id="history" />
        </div>
    </div>
    <script id="issues-template" type="text/x-handlebars-template">
        <div class="row">
            <div class="column grid_1 strong">Issue</div>
            <div class="column grid_6 strong">Summary</div>
            <div class="column grid_1 strong">Status</div>
            <div class="column grid_1 strong">Type</div>
            <div class="column grid_1 strong">DueDate</div>
            <div class="column grid_1 strong">Created</div>
            <div class="column grid_1 strong">Priority</div>
        </div>
        {{#issues}}
        <div class="row bordered">
            <div class="column grid_1">{{issue}}</div>
            <div class="column grid_3">{{summary}}</div>
            <div class="column grid_2">{{status}}</div>
            <div class="column grid_2">{{type}}</div>
            <div class="column grid_1">{{#if dueDate}} {{dueDate}} {{else}}&nbsp;{{/if}}</div>
            <div class="column grid_1">{{created}}</div>
            <div class="column grid_1">{{priority}}</div>
        </div>
        {{/issues}}
    </script>
    <script id="history-template" type="text/x-handlebars-template">
        <div class="row">
            <div class="column grid_1 strong">ID</div>
            <div class="column grid_6 strong">Issue</div>
            <div class="column grid_1 strong">Monday</div>
            <div class="column grid_1 strong">Tuesday</div>
            <div class="column grid_1 strong">Wednesday</div>
            <div class="column grid_1 strong">Thursday</div>
            <div class="column grid_1 strong">Friday</div>
        </div>
        {{#history}}
        <div class="row">
            <div class="column grid_1">{{geminiRef}}</div>
            <div class="column grid_6">{{issue}}</div>
            <div class="column grid_1">{{monday}}</div>
            <div class="column grid_1">{{tuesday}}</div>
            <div class="column grid_1">{{wednesday}}</div>
            <div class="column grid_1">{{thursday}}</div>
            <div class="column grid_1">{{friday}}</div>
        </div>
        {{/history}}
    </script>
</body>
</html>
